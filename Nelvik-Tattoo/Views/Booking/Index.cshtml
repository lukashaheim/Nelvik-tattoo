@model Nelvik_Tattoo.Models.Booking
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="css/booking.css">

<form method="post" enctype="multipart/form-data">
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>
    <div class="wizard booking-grid">
        <!-- Design / Concept -->
        <fieldset class="panel " id="p1">
            <legend>1. Design / Concept</legend>
            <label for="Design">Dette må endres</label>
            <textarea id="Design" name="Design" class="form-control" rows="6"
                      placeholder="Dette må også endres"></textarea>
        </fieldset>
        <!-- Placement -->
        <fieldset class="panel locked" id="p2">
            <legend>2. Placement</legend>
            <label for="Placement">Dette må endres</label>
            <textarea id="Placement" name="Placement" class="form-control" rows="6"
                      placeholder="Example. Forearm"></textarea>
        </fieldset>
        <!-- Size -->
        <fieldset class="panel locked" id="p3">
            <legend>3. Size</legend>
            <div class="size-grid">
                <input type="radio" class="btn-check" name="Size" id="small" value="Small" autocomplete="off">
                <label class="btn size-choice" for="small">Small<br>5–10 cm</label>

                <input type="radio" class="btn-check" name="Size" id="medium" value="Medium" autocomplete="off">
                <label class="btn size-choice" for="medium">Medium<br>10–20 cm</label>

                <input type="radio" class="btn-check" name="Size" id="large" value="Large" autocomplete="off">
                <label class="btn size-choice" for="large">Large<br>20–30 cm</label>

                <input type="radio" class="btn-check" name="Size" id="xl" value="Xl" autocomplete="off">
                <label class="btn size-choice" for="xl">XL<br>Over 30 cm</label>
            </div>
        </fieldset>
        <!-- Image -->
        <fieldset class="panel locked" id="p4" disabled>
            <legend>4. Image</legend>
            <label for="Photo">Upload</label>
            <input id="Photo" type="file" accept="image/*" class="form-control"/>
        </fieldset>
        <!-- Budget / Pricerange -->
        <fieldset class="panel locked" id="p5">
            <legend>5. Budget / Pricerange</legend>
            <textarea id="Budget" name="Budget" class="form-control" rows="6"
                      placeholder="Example. 3000 - 6500 kr"></textarea>
        </fieldset>
        <!-- Date / Time -->
        <fieldset class="panel locked" id="p6">
            <legend>6. Preferred Date / Time</legend>
            <label for="date">Date</label>
            <input id="date" asp-for="SelectedDate" class="form-control" asp-format="{0:yyyy-MM-dd}"/>
            <div style="display:flex; gap:10px; margin-top:10px">
                <div style="flex:1">
                    <label for="timeStart">From</label>
                    <input id="timeStart" asp-for="SelectedStartTime" class="form-control" asp-format="{0:HH\\:mm}"/>
                </div>
                <div style="flex:1">
                    <label for="timeEnd">To</label>
                    <input id="timeEnd" asp-for="SelectedEndTime" class="form-control" asp-format="{0:HH\\:mm}"/>
                </div>
            </div>
        </fieldset>
        <!-- Contact -->
        <fieldset class="panel locked" id="p7">
            <legend>7. Contact information</legend>
            <div class="row">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required/>
                <label for="phone">Phone number</label>
                <input type="number" id="phone" name="phone" required/>
            </div>
            
            <div class="row">
            <label>Preferred contact method</label>
            <label>
                <input id="emailCM" type="radio" name="contactMethod" value="email" required>
                Email
            </label>
            <label>
                <input id="phoneCM" type="radio" name="contactMethod" value="phone">
                SMS
            </label>
            </div>
        </fieldset>
        <!-- Comment -->
        <fieldset class="panel locked" id="p8" disabled>
            <legend>8. Comment</legend>
            <label for="Comment">Anything else we need to know?</label>
            <textarea id="Comment" name="Comment" class="form-control" rows="6"
                      placeholder="Example. Sensitive skin"></textarea>
        </fieldset>
    </div>

    <div class="actions">
        <button type="button" id="prev" class="btn btn-secondary" disabled>Back</button>
        <button type="button" id="next" class="btn btn-primary">Next</button>
        <form asp-controller="Booking" asp-action="Confirmation" method="post">
        <button type="submit" id="finish" class="btn btn-success" disabled>Finish</button>
        </form>

    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Pickers
    flatpickr("#date",{
        dateFormat:"d-m-Y",
        defaultDate:"today",
        minDate:"today",
        maxDate:new Date().fp_incr(61)}
    );
    const timeStartPicker = flatpickr("#timeStart",{
        enableTime:true,
        noCalendar:true,
        time_24hr:true,
        dateFormat:"H:i",
        minTime:"08:00",
        maxTime:"16:00",
        onChange:(_,str)=>timeEndPicker.set('minTime',str)}
    );
    const timeEndPicker = flatpickr("#timeEnd",{
        enableTime:true,
        noCalendar:true,
        time_24hr:true,
        dateFormat:"H:i",
        minTime:"08:00",
        maxTime:"16:00"}
    );

    // Paneler er alltid synlige; kun lås/åpne funksjon.
    let step = 1, max = 8;
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const finishBtn = document.getElementById('finish');

    function unlock(n){
        const fs = document.getElementById('p'+n);
        fs.disabled = false;
        fs.classList.remove('locked');
    }
    function lock(n){
        const fs = document.getElementById('p'+n);
        fs.disabled = true;
        fs.classList.add('locked');
    }
    function validate(n){
        if(n===6){
            const d = document.getElementById('date').value;
            const a = document.getElementById('timeStart').value;
            const b = document.getElementById('timeEnd').value;
            if(!d || !a || !b){ alert('Choose a date and time.'); return false; }
            if(a > b){ alert('end time cannot be before start time.'); return false; }
        }
        return true;
    }
    function ValidateContactMethod(n){
        if(n===7){
            const chosen = document.querySelector('input[name="contactMethod"]:checked');
            if(!chosen){ alert('Choose preferred contact method'); return false; }
        }
        return true;
    }
    function updateButtons(){
        prevBtn.disabled = step===1;
        nextBtn.disabled = step===max;
        finishBtn.disabled = step!==max;
    }
    
    function updateProgress() {
        const percent = (step / max) * 100;
        document.getElementById('progress').style.width = percent + '%';
    }
    
    prevBtn.onclick = () => {
        if(step>1) {
            step--;
            lock(step+1)
            updateButtons();
            updateProgress();
        } 
    };
    nextBtn.onclick = () => {
        if(!ValidateContactMethod(step)) return;
        if(!validate(step)) return;
        if(step < max){ 
            step++; 
            unlock(step); 
            updateButtons();
            updateProgress();
        }
    };
     updateButtons(); updateProgress();
</script>